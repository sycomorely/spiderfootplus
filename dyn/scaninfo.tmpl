<%include file="HEADER.tmpl"/>
<h2>${name}</h2>
  <div class="btn-toolbar">
    <div class="btn-group">
      <a id='btn-browse' class="btn active" href="#" onClick='browseEventList("${id}")'>Browse</a>
      <a id='btn-info' class="btn" href="#" onClick='viewScanConfig("${id}")'>Scan Info</a>
      <a id='btn-export' class="btn" href="#">Export</a>
    </div>
  </div>

<div id=loader>
Loading...
<div class="progress progress-striped active">
    <div class="bar" style="width: 100%"></div>
</div>
</div>

    <script type='text/javascript'>
        function navTo(target) {
            var targets = [ "btn-browse", "btn-info", "btn-export" ]
            for (var i = 0; i < targets.length; i++) {
                if (targets[i] == target) {
                    $("#" + targets[i]).addClass("active");
                } else {
                    $("#" + targets[i]).removeClass("active");
                }
            }
        }

        // Summary of event types and counts for a scan
        function browseEventList(instanceId) {
            // Remove pre-existing tables if they exist
            $("#scansummary-content").remove();
            navTo("btn-browse");
            $("#loader").show();
            sf.fetchData('/scansummary', {'id': instanceId}, function(data) {
                            var table = "<table id='scansummary-content' class='table table-bordered table-striped'>";
                            table += "<thead><tr> <th>Type</th> <th>Events</th><th>Last Provided</th></tr></thead><tbody>";
                            for (var i = 0; i < data.length; i++) {
                                table += "<tr><td><a onClick='";
                                table += "browseEventData(\"${id}\", \"" + data[i][0] + "\")' href='#'>";
                                table += data[i][1] + "</a></td>";
                                table += "<td>" + data[i][3] + "</td>";
                                table += "<td>" + data[i][2] + "</td>";
                            }
                            table += "</tbody></table>"
                            $("#loader").fadeOut(250);
                            $("#mainbody").append(table);
            });
        }

        // Detailed view of data for an event type for a scan
        function browseEventData(instanceId, eventType) {
            $("#scansummary-content").remove();
            $("#loader").show();
            navTo("btn-browse");
            sf.fetchData('/scaneventresults', {'id': instanceId, 'eventType': eventType }, function(data) {
                            var table = "<table id='scansummary-content' class='table table-bordered table-striped small'>";
                            table += "<thead><tr> <th>Data Element</th><th>Obtained</th><th>Source</th><th>Module</th></tr></thead><tbody>";
                            for (var i = 0; i < data.length; i++) {
                                table += "<tr><td width=50%><pre>" + data[i][1] + "</pre></td><td>" + data[i][0] + "</td><td>" + data[i][2] + "</td><td>" + data[i][3] + "</td></tr>";
                            }
                            table += "</tbody></table>"
                            $("#loader").fadeOut(250);
                            $("#mainbody").append(table);
            });
        }

        // View the configuration that was used for this scan
        function viewScanConfig(instanceId) {
            $("#scansummary-content").remove();
            $("#loader").show();
            navTo("btn-info");
            sf.fetchData('/scanopts', {'id': instanceId}, function(data) {
                table = "<div id='scansummary-content'>";
                table += "<h4>Meta Information</h4>";
                table += "<table class='table table-bordered table-striped' style='width: 400px'>";
                table += "<tr><td>Name:</td><td>" + data['meta'][0] + "</td></tr>";
                table += "<tr><td>Target:</td><td>" + data['meta'][1] + "</td></tr>";
                table += "<tr><td>Started:</td><td>" + data['meta'][3] + "</td></tr>";
                table += "<tr><td>Completed:</td><td>" + data['meta'][4] + "</td></tr>";
                table += "<tr><td>Status:</td><td>" + data['meta'][5] + "</td></tr>";
                table += "</table>";
                table += "<h4>Global Settings</h4>";
                table += "<table class='table table-bordered table-striped' style='width: 400px'>";
                table += "<thead><tr> <th>Option</th> <th>Value</th></tr></thead><tbody>";
                for (var key in data['config']) {
                    if (key.indexOf(":") > 0) {
                        continue;
                    }
                    table += "<tr><td>" + key + "</td><td>" + data['config'][key] + "</td></tr>";
                }
                table += "</table>";
                table += "<h4>Module Settings</h4>";
                table += "<table class='table table-bordered table-striped' style='width: 400px'>";
                table += "<thead><tr><th>Module</th> <th>Option</th> <th>Value</th></tr></thead><tbody>";
                for (var key in data['config']) {
                    if (key.indexOf(":") > 0) {
                        bits = key.split(":");
                        table += "<tr><td>" + bits[0] + "</td><td>" + bits[1] + "</td><td>" + data['config'][key] + "</td></tr>";
                    }
                }
                table += "</table></div>";

                $("#loader").fadeOut(250);
                $("#mainbody").append(table);
            });
        }

        browseEventList("${id}");

    </script>
<%include file="FOOTER.tmpl"/>
